var FlowerImagebox=new Class({Extends:FlowerOverlay,Implements:Options,options:{contentspcbg:"#ffffff",boxwidth:60,boxheight:60,fixedSize:false,fullPreload:false},initialize:function(a){this.name="imagebox";this.version=1;this.donotdebugoptions=false;this.ismobile=flowerUID.getModule("utility").checkForMobile();this.state=0;this.setOptions(a);this.caption="";this.renderboxheight=this.options.boxheight;this.renderboxwidth=this.options.boxwidth;this.collections=$H();this.newCollection("default");this.addKeyEvents();this.computeMaxSize()},attachToElement:function(b){if(!this.ismobile){if(b.get("tag")=="a"){this.addFromLink(b,"default")}else{if(b.get("tag")=="div"){var c="default",a=b.get("id");if(a){c=a}b.getElements("a[href*=.jpg],a[href*=.jpeg],a[href*=.gif],a[href*=.png]").each(function(d){this.addFromLink(d,c)}.bind(this))}}}},addFromLink:function(a,b){a.removeEvents("click");var g=a.getProperty("href"),e=a.getProperty("title"),f=a.getProperty("rev"),h=0,i=0,d="featured imgage",j,c;if(f){if(f.contains("imagebox:")){$A(f.substring(9,f.length).split(",")).each(function(l){var k=l.split("=");switch(k[0]){case"width":if(k[1]){h=k[1]}break;case"height":if(k[1]){i=k[1]}break;case"alt":if(k[1]){d=k[1]
}break;case"collection":if(k[1]){b=k[1]}break}}.bind(this))}}if(!this.collections.get(b)){this.newCollection(b)}c=g;this.addToCollection(b,g,e,d,h,i,a);a.addEvent("click",function(k){this.showImage(b,g);k.stop()}.bind(this))},showImage:function(a,b){this.currentCollection=a;this.collections.get(a).set("currentKey",b);if(this.state==0){this.createDomElements();this.resizeContentSpc=new Fx.Morph(this.overlayContentSpc,{duration:400});this.fadeOverlayCaptionSpc=new Fx.Tween(this.overlayCaptionSpc,{property:"opacity",duration:100,link:"cancel"});this.createImages();this.currentImg.fade("hide");this.state=1}this.showOverlay()},addControlElements:function(){this.parent();this.overlayCloseLink.set("html","close <small>[esc]</small>");this.overlayPrevLink=new Element("a",{"class":"flower_overlay_controllink",styles:{color:this.options.linkcolor,margin:"0 1.3em 0 0",cursor:"pointer"},html:"previous <small>[&#8592;]</small>",events:{mouseover:function(a){this.overlayPrevLink.setStyle("color",this.options.linkovercolor)}.bind(this),mouseout:function(a){this.overlayPrevLink.setStyle("color",this.options.linkcolor)}.bind(this),click:function(a){this.previousImage();a.stop()}.bind(this)}}).inject(this.overlayCloseLink,"before");
this.overlayNextLink=new Element("a",{"class":"flower_overlay_controllink",styles:{color:this.options.linkcolor,margin:"0 0 0 1.3em",cursor:"pointer"},html:"next <small>[&#8594;]</small>",events:{mouseover:function(a){this.overlayNextLink.setStyle("color",this.options.linkovercolor)}.bind(this),mouseout:function(a){this.overlayNextLink.setStyle("color",this.options.linkcolor)}.bind(this),click:function(a){this.nextImage();a.stop()}.bind(this)}}).inject(this.overlayCloseLink,"after")},addKeyEvents:function(){document.addEvent("keydown",function(a){if(this.state==11){switch(a.key){case"left":this.previousImage();break;case"right":this.nextImage();break;case"esc":this.hideOverlay();break}}}.bind(this))},computeMaxSize:function(){var a=window.getSize();this.maxSize=$H({x:a.x-80,y:a.y-120})},newCollection:function(a){this.collections.set(a,$H());this.collections.get(a).set("order",[]);this.collections.get(a).set("currentKey",0)},addToCollection:function(d,f,g,h,i,c,b){var a,e=this.collections.get(d);a=$H({el:b,href:f,caption:g,alt:h,w:i,h:c,loaded:-1});e.set(f,a);e.get("order").push(f);if(this.options.fullPreload){this.preloadAndMeasure(d,f)}},preloadAndMeasure:function(c,e){var g=this.collections.get(c).get(e),f,b,a,d;
if(g&&g.get("loaded")==-1){g.set("loaded",0);f=g.get("href");b=g.get("w");a=g.get("h");d=new Image();d.onload=function(){if(b==0||a==0){g.set("w",d.width);g.set("h",d.height)}g.set("loaded",1);if(this.debugMsg){this.debugMsg(1,'loaded "'+d.src+'" in collection "'+c+'"')}};d.onerror=function(){var h=this.collections.get(c);if(h.get(f).get("el")){h.get(f).get("el").removeEvents("click")}h.erase(e);h.get("order").erase(e);if(this.debugMsg){this.debugMsg(1,'cannot load "'+d.src+'", removing it from collection "'+c+'"')}}.bind(this);d.src=f}},createImages:function(){this.currentImg=new Element("img",{"class":"flower_imagebox_img",src:"",alt:"",styles:{visibility:"hidden",position:"relative",width:"100%",height:"100%","z-index":10}}).inject(this.overlayContentSpc);this.currentImg.addEvent("click",function(){this.nextImage()}.bind(this));this.fadeCurrentImage=new Fx.Tween(this.currentImg,{property:"opacity",duration:200,link:"chain"})},changeImage:function(d,h){var e=this.collections.get(d),a=e.get(h);e.set("currentKey",h);if(!a){if(e.getLength()>0){this.nextImage()}else{this.state=11;this.hideOverlay()}}else{if(a.get("loaded")<1){this.state=11;this.preloadAndMeasure(d,h);(function(){this.changeImage(d,h)
}.bind(this)).delay(100)}else{this.state=10;this.preloadAndMeasure(d,e.get("order")[this.nextPlace()]);this.preloadAndMeasure(d,e.get("order")[this.previousPlace()]);this.fadeCurrentImage.start(0);if(!this.options.fixedSize){this.computeMaxSize();if(a.get("w")==0){this.renderboxwidth=this.options.boxwidth}else{this.renderboxwidth=a.get("w")}if(a.get("h")==0){this.renderboxheight=this.options.boxheight}else{this.renderboxheight=a.get("h")}var g=this.maxSize.get("x"),f=this.maxSize.get("y");if(this.renderboxwidth>g||this.renderboxheight>f){var c=this.renderboxwidth,b=this.renderboxheight,j=c-g,i=b-f;if(j>i){this.renderboxwidth=g;this.renderboxheight=(b*(g/c)).round()}else{this.renderboxheight=f;this.renderboxwidth=(c*(f/b)).round()}}}this.caption=a.get("caption");this.currentImg.set("alt",a.get("alt"));this.fadeOverlayCaptionSpc.set(0);this.positionCaption();this.state=10;this.resizeContentSpc.start({height:this.renderboxheight,width:this.renderboxwidth,"margin-top":(0-(this.renderboxheight/2)-this.options.borderwidth),"margin-left":(0-(this.renderboxwidth/2)-this.options.borderwidth)}).chain(function(){this.currentImg.src=a.get("href");(function(){this.fadeCurrentImage.start(1).chain(function(){this.state=11
}.bind(this));this.fadeOverlayCaptionSpc.start(1)}.bind(this)).delay(120)}.bind(this))}}},nextPlace:function(){var c=this.collections.get(this.currentCollection),b=c.get("order").length,a=0;if(c.get("order").indexOf(c.get("currentKey"))+2<=b){a=c.get("order").indexOf(c.get("currentKey"))+1}return a},previousPlace:function(){var c=this.collections.get(this.currentCollection),a=c.get("order").length,b;if(c.get("order").indexOf(c.get("currentKey"))>0){b=c.get("order").indexOf(c.get("currentKey"))-1}else{b=a-1}return b},nextImage:function(){if(this.state==11){var b=this.collections.get(this.currentCollection),a=b.get("order").length;if(a>1){this.changeImage(this.currentCollection,b.get("order")[this.nextPlace()])}}},previousImage:function(){if(this.state==11){var b=this.collections.get(this.currentCollection),a=b.get("order").length;if(a>1){this.changeImage(this.currentCollection,b.get("order")[this.previousPlace()])}}},showOverlay:function(){if(this.state==1){if(this.collections.get(this.currentCollection).get("order").length<2){this.overlayPrevLink.setStyle("display","none");this.overlayNextLink.setStyle("display","none")}this.parent();this.state=10}},showContent:function(){this.fadeCurrentImage.set(0);
this.changeImage(this.currentCollection,this.collections.get(this.currentCollection).get("currentKey"))},hideOverlay:function(){if(this.state==11){this.currentImg.setStyle("visibility","hidden");this.currentImg.src="";if(!this.options.fixedSize){this.renderboxheight=this.options.boxheight;this.renderboxwidth=this.options.boxwidth;this.overlayContentSpc.setStyles({height:this.renderboxheight,width:this.renderboxwidth,"margin-top":(0-(this.renderboxheight/2)),"margin-left":(0-(this.renderboxwidth/2))})}this.overlayCaptionSpc.fade("hide");this.parent();if(this.collections.get(this.currentCollection).getLength()<2){this.overlayPrevLink.setStyle("display","inline");this.overlayNextLink.setStyle("display","inline")}this.state=1}}});window.addEvent("domready",function(){if(typeof(flowerUID)=="object"){flowerUID.registerModule(FlowerImagebox,"imagebox")}else{var a=new FlowerImagebox();$$("a.flower_imagebox,div.flower_imagebox").each(function(b){a.attachToElement(b)})}});