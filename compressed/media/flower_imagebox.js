var FlowerImagebox=new Class({Extends:FlowerOverlay,Implements:Options,options:{contentspcbg:"#ffffff",boxwidth:60,boxheight:60,fixedSize:false,fullPreload:true},initialize:function(a){this.name="imagebox";this.version=1;this.donotdebugoptions=false;this.ismobile=flowerUID.getModule("utility").checkForMobile();this.state=0;this.setOptions(a);this.caption="";this.renderboxheight=this.options.boxheight;this.renderboxwidth=this.options.boxwidth;this.collections=$H();this.newCollection("default");this.addKeyEvents();this.computeMaxSize();},attachToElement:function(b){if(!this.ismobile){if(b.get("tag")=="a"){this.addFromLink(b,"default");}else{if(b.get("tag")=="div"){var c="default",a=b.get("id");if(a){c=a;}b.getElements("a").each(function(d){var e=d.getProperty("href");if(e.toLowerCase().contains(".jpg")||e.toLowerCase().contains(".jpeg")||e.toLowerCase().contains(".gif")||e.toLowerCase().contains(".png")){this.addFromLink(d,c);}}.bind(this));}}}},addFromLink:function(a,b){a.removeEvents("click");var f=a.getProperty("href"),e=a.getProperty("title"),j=a.getProperty("rev"),g=0,h=0,d="featured imgage",i,c;if(j){if(j.contains("imagebox:")){$A(j.substring(9,j.length).split(",")).each(function(k){i=k.split("=");if(i[0]=="width"){g=i[1];}else{if(i[0]=="height"){h=i[1];}else{if(i[0]=="alt"){d=i[1];}else{if(i[0]=="collection"){b=i[1];}}}}}.bind(this));}}if(!this.collections.get(b)){this.newCollection(b);}c=this.collections.get(b).length;this.addToCollection(b,f,e,d,g,h);a.addEvent("click",function(k){this.showImage(b,c);k.stop();}.bind(this));},showImage:function(a,b){this.currentCollection=a;this.currentPlace=b;if(this.state==0){this.createDomElements();this.resizeContentSpc=new Fx.Morph(this.overlayContentSpc,{duration:400});this.fadeOverlayCaptionSpc=new Fx.Tween(this.overlayCaptionSpc,{property:"opacity",duration:100,link:"cancel"});this.createImages();this.currentImg.fade("hide");this.state=1;}this.showOverlay();},addControlElements:function(){this.parent();this.overlayCloseLink.set("html","close <small>[esc]</small>");this.overlayPrevLink=new Element("a",{"class":"cui_overlaycontrollink",styles:{color:this.options.linkcolor,margin:"0 1.3em 0 0",cursor:"pointer"},html:"previous <small>[&#8592;]</small>",events:{mouseover:function(a){this.overlayPrevLink.setStyle("color",this.options.linkovercolor);}.bind(this),mouseout:function(a){this.overlayPrevLink.setStyle("color",this.options.linkcolor);}.bind(this),click:function(a){this.previousImage();a.stop();}.bind(this)}}).inject(this.overlayCloseLink,"before");this.overlayNextLink=new Element("a",{"class":"cui_overlaycontrollink",styles:{color:this.options.linkcolor,margin:"0 0 0 1.3em",cursor:"pointer"},html:"next <small>[&#8594;]</small>",events:{mouseover:function(a){this.overlayNextLink.setStyle("color",this.options.linkovercolor);}.bind(this),mouseout:function(a){this.overlayNextLink.setStyle("color",this.options.linkcolor);}.bind(this),click:function(a){this.nextImage();a.stop();}.bind(this)}}).inject(this.overlayCloseLink,"after");},addKeyEvents:function(){document.addEvent("keydown",function(a){if(this.state==11){switch(a.key){case"left":this.previousImage();break;case"right":this.nextImage();break;case"esc":this.hideOverlay();break;}}}.bind(this));},computeMaxSize:function(){var a=window.getSize();this.maxSize=$H({x:a.x-80,y:a.y-120});},newCollection:function(a){this.collections.set(a,[]);},addToCollection:function(b,e,i,d,f,g){var a=[e,i,d,f,g,-1],h=this.collections.get(b);h.push(a);if(this.options.fullPreload){var c=h.length-1;this.preloadAndMeasure(b,c);}},preloadAndMeasure:function(c,g){var f=this.collections.get(c)[g],e,b,a,d;if(f&&f[5]==-1){f[5]=0;e=f[0],b=f[3],a=f[4],d=new Image();d.onload=function(){if(b==0||a==0){f[3]=d.width;f[4]=d.height;}f[5]=1;};d.onerror=function(){var i=this.collections.get(c);var h=i.filter(function(k,j){return j!=g;});this.collections.set(c,h);if(this.debugMsg){this.debugMsg(1,'cannot load "'+d.src+'", removing it from collection "'+c+'"');}}.bind(this);d.src=e;}},createImages:function(){this.currentImg=new Element("img",{"class":"FlowerImageboximg",src:"",alt:"",styles:{visibility:"hidden",position:"relative",width:"100%",height:"100%","z-index":10}}).inject(this.overlayContentSpc);this.currentImg.addEvent("click",function(){this.nextImage();}.bind(this));this.fadeCurrentImage=new Fx.Tween(this.currentImg,{property:"opacity",duration:200,link:"chain"});},changeImage:function(d,e){var a=this.collections.get(d)[e];this.currentPlace=e;if(!a){if(this.collections.get(d).length){this.nextImage();}else{this.state=11;this.hideOverlay();}}else{if(a[5]<1){this.state=11;this.preloadAndMeasure(d,e);(function(){this.changeImage(d,e);}.bind(this)).delay(100);}else{this.state=10;this.preloadAndMeasure(this.currentCollection,this.nextPlace());this.preloadAndMeasure(this.currentCollection,this.previousPlace());this.fadeCurrentImage.start(0);if(!this.options.fixedSize){this.computeMaxSize();if(a[3]==0){this.renderboxwidth=this.options.boxwidth;}else{this.renderboxwidth=a[3];}if(a[4]==0){this.renderboxheight=this.options.boxheight;}else{this.renderboxheight=a[4];}var g=this.maxSize.get("x"),f=this.maxSize.get("y");if(this.renderboxwidth>g||this.renderboxheight>f){var c=this.renderboxwidth,b=this.renderboxheight,i=c-g,h=b-f;if(i>h){this.renderboxwidth=g;this.renderboxheight=(b*(g/c)).round();}else{this.renderboxheight=f;this.renderboxwidth=(c*(f/b)).round();}}}this.caption=a[1];this.currentImg.set("alt",a[2]);this.fadeOverlayCaptionSpc.set(0);this.positionCaption();this.state=10;this.resizeContentSpc.start({height:this.renderboxheight,width:this.renderboxwidth,"margin-top":(0-(this.renderboxheight/2)-this.options.borderwidth),"margin-left":(0-(this.renderboxwidth/2)-this.options.borderwidth)}).chain(function(){this.currentImg.src=a[0];(function(){this.fadeCurrentImage.start(1).chain(function(){this.state=11;}.bind(this));this.fadeOverlayCaptionSpc.start(1);}.bind(this)).delay(120);}.bind(this));}}},nextPlace:function(){var b=this.collections.get(this.currentCollection).length,a=0;if(this.currentPlace+2<=b){a=this.currentPlace+1;}return a;},previousPlace:function(){var a=this.collections.get(this.currentCollection).length,b;if(this.currentPlace>0){b=this.currentPlace-1;}else{b=a-1;}return b;},nextImage:function(){if(this.state==11){var a=this.collections.get(this.currentCollection).length;if(a>1){this.changeImage(this.currentCollection,this.nextPlace());}}},previousImage:function(){if(this.state==11){var a=this.collections.get(this.currentCollection).length;if(a>1){this.changeImage(this.currentCollection,this.previousPlace());}}},showOverlay:function(){if(this.state==1){if(this.collections.get(this.currentCollection).length<2){this.overlayPrevLink.setStyle("display","none");this.overlayNextLink.setStyle("display","none");}this.parent();this.state=10;}},showContent:function(){this.fadeCurrentImage.set(0);this.changeImage(this.currentCollection,this.currentPlace);},hideOverlay:function(){if(this.state==11){this.currentImg.setStyle("visibility","hidden");this.currentImg.src="";if(!this.options.fixedSize){this.renderboxheight=this.options.boxheight;this.renderboxwidth=this.options.boxwidth;this.overlayContentSpc.setStyles({height:this.renderboxheight,width:this.renderboxwidth,"margin-top":(0-(this.renderboxheight/2)),"margin-left":(0-(this.renderboxwidth/2))});}this.overlayCaptionSpc.fade("hide");this.parent();if(this.collections.get(this.currentCollection).length<2){this.overlayPrevLink.setStyle("display","inline");this.overlayNextLink.setStyle("display","inline");}this.state=1;}}});window.addEvent("domready",function(){if(typeof(flowerUID)=="object"){flowerUID.registerModule(FlowerImagebox,"imagebox");}else{var a=new FlowerImagebox();$$("a.flower_imagebox,div.flower_imagebox").each(function(b){a.attachToElement(b);});}});