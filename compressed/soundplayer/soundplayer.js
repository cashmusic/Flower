var SoundPlayer=new Class({Implements:[Events,Options],options:{volume:100,debug:false,forceFlash:false,sm2LoadTimeout:1500,sm2Location:"/assets/scripts/lib/soundmanager2/soundmanager2.js",sm2swfLocation:"/assets/scripts/lib/soundmanager2/swf/"},initialize:function(a){this.setOptions(a);this.sm2Loaded=false;this.currentSound=null;this.currentPlaylist=null;this.Playlists=new Hash();this.soundManager=null;this.sm2LoadTimer=null;this.sm2LoadTime=0;this.isReady=false;this.isAppleiDevice=false;if((navigator.userAgent.match(/iPad/i)!=null)||(navigator.userAgent.match(/iPhone/i)!=null)||(navigator.userAgent.match(/iPod/i)!=null)){this.isAppleiDevice=true;}window.addEvent("domready",function(){window.SM2_DEFER=true;injected=new Element("script",{type:"text/javascript",src:this.options.sm2Location}).injectInside($$("head")[0]);this.sm2LoadTimer=(function(){if(typeof(soundManager)!="undefined"){this.initializeSM2();$clear(this.sm2LoadTimer);}else{this.sm2LoadTime+=50;if(this.sm2LoadTime>this.options.sm2LoadTimeout){this.onError("soundmanager2 could not be loaded/found.");$clear(this.sm2LoadTimer);}}}).periodical(50,this);}.bind(this));},initializeSM2:function(){window.soundManager=new SoundManager();soundManager.url=this.options.sm2swfLocation;soundManager.flashVersion=9;soundManager.useFlashBlock=false;if(!this.options.forceFlash){soundManager.useHTML5Audio=true;}soundManager.flashLoadTimeout=this.options.sm2LoadTimeout;soundManager.debugMode=this.options.debug;soundManager.onready(function(){if(soundManager.supported()){this.soundManager=soundManager;this.onFlashLoaded();}else{this.onError("soundmanager2 loaded but is not supported");}}.bind(this));soundManager.beginDelayedInit();},debugMessage:function(a){if(typeof(console)=="object"&&this.options.debug){console.log(a);}},loadPlaylist:function(c,a,b){if(!this.sm2Loaded){this.onError("flash object not yet loaded. please use the 'ready' event.");}else{this.currentPlaylist=this.Playlists.get(c);if(this.currentPlaylist===null){this.Playlists.set(c,new SoundPlaylist(b));this.currentPlaylist=this.Playlists.get(c);}this.currentPlaylist.setSoundPlayer(this);a.each(function(d){this.currentPlaylist.loadSound(d);},this);}return this;},playCurrentSound:function(){if(this.currentPlaylist===null){this.onError("there are no playlists loaded.");}else{this.currentPlaylist.playCurrentSound();}},stopCurrentSound:function(){if(this.currentPlaylist===null){this.onError("there are no playlists loaded.");}else{this.currentPlaylist.stopCurrentSound();}},resumeCurrentSound:function(){if(this.currentPlaylist===null){this.onError("there are no playlists loaded.");}else{this.currentPlaylist.resumeCurrentSound();}},pauseCurrentSound:function(){if(this.currentPlaylist===null){this.onError("there are no playlists loaded.");}else{this.currentPlaylist.pauseCurrentSound();}},toggleCurrentSound:function(){if(this.currentPlaylist===null){this.onError("there are no playlists loaded.");}else{this.currentPlaylist.toggleCurrentSound();}},jumpCurrentSoundTo:function(a){if(this.currentPlaylist===null){this.onError("there are no playlists loaded.");}else{this.currentPlaylist.jumpCurrentSoundTo(a);}},setVolume:function(a){this.swf.setVolume(a);this.options.volume=a;return this;},getVolume:function(){return this.options.volume;},onFlashLoaded:function(){if(!this.isReady){this.sm2Loaded=true;this.soundManager.defaultOptions.volume=this.options.volume;this.fireEvent("ready");this.isReady=true;}},onError:function(a){this.debugMessage("flower soundplayer error: "+a);this.fireEvent("error");}});var SoundPlaylist=new Class({Implements:[Options,Events],options:{loopPlaylist:false},initialize:function(c,a,b){this.setOptions(b);this.SoundPlayer=null;this.sounds=new Hash();this.currentSound=null;this.currentKey=-1;this.usingHTML5=false;},setSoundPlayer:function(a){this.SoundPlayer=a;return this;},loadSound:function(b){var a=b;if(typeof(b)=="string"){a={url:b,title:false,artist:false};}this.sounds.set(a.url,{sound:this.SoundPlayer.soundManager.createSound({id:a.url,url:a.url,onfinish:function(){this.playSound("next");this.SoundPlayer.fireEvent("soundEnd");}.bind(this),whileplaying:function(){if(!this.currentSound.sound.loaded){currentDuration=this.currentSound.sound.durationEstimate;}else{currentDuration=this.currentSound.sound.duration;}approximatePosition=this.currentSound.sound.position/currentDuration;this.SoundPlayer.fireEvent("position",approximatePosition);currentDuration=Math.round(currentDuration/1000);figureSeconds=Math.floor(currentDuration%60);figureSeconds=(String(figureSeconds).length<2)?figureSeconds=String("0"+figureSeconds):figureSeconds=String(figureSeconds);currentDuration=Math.floor(currentDuration/60)+":"+figureSeconds;currentPosition=Math.round(this.currentSound.sound.position/1000);figureSeconds=Math.floor(currentPosition%60);figureSeconds=(String(figureSeconds).length<2)?figureSeconds=String("0"+figureSeconds):figureSeconds=String(figureSeconds);currentPosition=Math.floor(currentPosition/60)+":"+figureSeconds;this.SoundPlayer.fireEvent("positiontime",[currentPosition+" / "+currentDuration,this.currentSound.sound.url]);if(this.usingHTML5){loadPercentage=this.currentSound.sound.bytesLoaded/this.currentSound.sound.bytesTotal;this.SoundPlayer.fireEvent("progress",loadPercentage);}}.bind(this),whileloading:function(){if(!this.usingHTML5){loadPercentage=this.currentSound.sound.bytesLoaded/this.currentSound.sound.bytesTotal;this.SoundPlayer.fireEvent("progress",loadPercentage);}}.bind(this),}),title:a.title,artist:a.artist});if(this.sounds.get(a.url).sound.isHTML5){this.usingHTML5=true;}return this;},playSound:function(c){var e,b,d=false,a=this.sounds.getKeys();if(c=="next"){if(this.currentKey==(a.length-1)&&this.options.loopPlaylist){d=0;}else{if(this.currentKey==(a.length-1)&&!this.options.loopPlaylist){d=false;}else{d=this.currentKey+1;}}}else{if(c=="forcenext"){if(this.currentKey==(a.length-1)){d=0;}else{d=this.currentKey+1;}}else{if(c=="previous"){if(this.currentSound!=null){if(this.currentKey==0){d=a.length-1;}else{d=this.currentKey-1;}}}else{if(c=="random"){d=Math.floor(Math.random()*a.length);}else{if(c=="first"){d=0;}}}}}if(this.currentSound){this.currentSound.sound.setPosition(0);this.stopCurrentSound();}if(d!==false){b=a[d];e=this.sounds.get(b);this.currentKey=d;this.currentSound=e;this.playCurrentSound();}},resumeCurrentSound:function(){if(this.currentSound.sound.paused){this.currentSound.sound.resume();this.SoundPlayer.fireEvent("resume");}},playCurrentSound:function(){if(this.currentSound.sound.paused){this.currentSound.sound.setPosition(0);this.currentSound.sound.resume();}else{this.currentSound.sound.play();}this.SoundPlayer.fireEvent("play",[this.currentSound.sound.url,this.currentSound.title,this.currentSound.artist]);},pauseCurrentSound:function(){if(this.currentSound.sound.playState==1){this.currentSound.sound.pause();this.SoundPlayer.fireEvent("pause");}},stopCurrentSound:function(){if(this.currentSound.sound.playState!=0){this.currentSound.sound.stop();this.SoundPlayer.fireEvent("stop");}},toggleCurrentSound:function(){if(this.currentSound){if(this.currentSound.sound.playState==0){this.playCurrentSound();}else{if(this.currentSound.sound.paused){this.resumeCurrentSound();}else{this.pauseCurrentSound();}}}else{this.playSound("first");}},jumpCurrentSoundTo:function(a){this.currentSound.sound.setPosition(a);if(this.currentSound.sound.paused){this.resumeCurrentSound();}this.fireEvent("play",[this.currentSound.sound.url,this.currentSound.title,this.currentSound.artist]);},});var SoundPlayerUI=new Class({Implements:[Options,Events],options:{debug:false},initialize:function(c,b,a){this.setOptions(a);if(this.options.playlist!=false){this.supportsAppleiDevices=true;this.targetElement=b;this.playlist=c;this.isAppleiDevice=this.playlist.SoundPlayer.isAppleiDevice;this.allSoundKeys=this.playlist.sounds.getKeys();}else{if(this.options.debug){this.debugMessage("No playlist specified, cannot draw UI.");}}},debugMessage:function(a){if(typeof(console)=="object"&&this.options.debug){console.log(a);}}});var _defaultSoundPlayerUI=new Class({Extends:SoundPlayerUI,Implements:[Options,Events],options:{debug:false,forceAppleiDevice:false,controlImages:{previous:"/assets/images/previous.png",next:"/assets/images/next.png",play:"/assets/images/play.png",pause:"/assets/images/pause.png"},customElementStyles:null},initialize:function(c,b,a){this.parent(c,b,a);this.setOptions(a);if(this.options.forceAppleiDevice){this.isAppleiDevice=true;}this.allPlaylistLi=new Hash();this.notesSpan=new Element("span",{text:"(tap to stop)",styles:{display:"none",color:"#111","padding-left":"1em"}});this.elementStyles=new Hash({seekbarSpc:{position:"relative","background-color":"#000",height:"9px",width:"100%","margin-top":"4px",overflow:"hidden"},seekbar:{position:"absolute","background-color":"#00acf1",height:"9px",width:"0%",cursor:"pointer","z-index":"10"},position:{position:"absolute",left:"0%",width:"3px",height:"9px","background-color":"#fff402","z-index":"15"},controls:{"margin-top":"8px","text-align":"right"},iDeviceLiStyles:{background:"-webkit-gradient(linear, left top, left bottom, from(#666), to(#222))",color:"#fff"},iDeviceLiStylesClicked:{background:"-webkit-gradient(linear, left top, left bottom, from(#00acf1), to(#002939))",color:"#ed028d"},controlImageStyles:{"margin-left":"4px",cursor:"pointer"}});},clearAllPlaylistLi:function(){this.notesSpan.setStyle("display","none");this.allPlaylistLi.each(function(a){a.get("li").setStyles(this.elementStyles.get("iDeviceLiStyles"));a.get("titlespan").setStyle("color","#fff");a.get("timespan").set("html","");}.bind(this));},handlePlaylistLiClick:function(a){var b=this.playlist.sounds.get(a);var c=false;if(this.playlist.currentSound){if(this.playlist.currentSound.sound.playState==0&&this.playlist.currentKey==this.allSoundKeys.indexOf(a)){c=true;}}if(this.playlist.currentKey!=this.allSoundKeys.indexOf(a)||c){if(this.playlist.currentSound){this.playlist.currentSound.sound.setPosition(0);this.playlist.stopCurrentSound();}this.playlist.currentKey=this.allSoundKeys.indexOf(a);this.playlist.currentSound=b;this.playlist.playCurrentSound();this.highlightPlayingLi(a);}else{this.playlist.stopCurrentSound();this.clearAllPlaylistLi();}},highlightPlayingLi:function(b){this.clearAllPlaylistLi();var d=this.allPlaylistLi.get(b);var e=d.get("timespan");var c=d.get("titlespan");var a=d.get("li");if(e.get("html")==""){e.set("html","loading...");}a.setStyles(this.elementStyles.get("iDeviceLiStylesClicked"));c.setStyle("color","#000");this.notesSpan.inject(a);this.notesSpan.setStyle("display","inline");},addPlaylistElements:function(){if(!this.isAppleiDevice){this.mainPlaylistUl=new Element("ol",{styles:{"font-size":"0.85em",padding:0,margin:0,"list-style-type":"decimal-leading-zero"}});this.playlist.sounds.each(function(b,c){var a=new Element("li",{styles:{"list-style-position":"inside"}}).inject(this.mainPlaylistUl);var d=new Element("span",{text:b.title,styles:{cursor:"pointer"},events:{click:function(){sound=this.playlist.sounds.get(b.sound.url);if(this.playlist.currentSound){this.playlist.currentSound.sound.setPosition(0);this.playlist.stopCurrentSound();}this.playlist.currentKey=this.allSoundKeys.indexOf(b.sound.url);this.playlist.currentSound=sound;this.playlist.playCurrentSound();}.bind(this)}}).inject(a);},this);this.mainPlaylistUl.inject(document.id(this.targetElement));}else{this.mainPlaylistUl=new Element("ol",{styles:{"font-size":"0.85em",padding:0,margin:0,"list-style-type":"decimal-leading-zero"}});this.playlist.sounds.each(function(b,c){var a=new Element("li",{styles:{"list-style-position":"inside",background:"-webkit-gradient(linear, left top, left bottom, from(#666), to(#222))",border:"1px solid #777","-webkit-border-radius":"3px","margin-bottom":"4px",padding:"3px",height:"4em",cursor:"pointer",color:"#fff"}}).inject(this.mainPlaylistUl);var d=new Element("span",{text:b.title,styles:{"font-size":"1.5em","line-height":"1em","font-weight":"bold",display:"block"}}).inject(a);var e=new Element("span",{styles:{"padding-left":"1.95em",color:"#fff"}}).inject(a);a.addEvent("click",function(){this.handlePlaylistLiClick(b.sound.url);}.bind(this));this.allPlaylistLi.set(b.sound.url,new Hash({li:a,titlespan:d,timespan:e}));},this);this.mainPlaylistUl.inject(document.id(this.targetElement));}},addPlaylistEvents:function(){if(!this.isAppleiDevice){}else{this.playlist.SoundPlayer.addEvent("play",function(a){this.highlightPlayingLi(a);}.bind(this));this.playlist.SoundPlayer.addEvent("positiontime",function(b,a){this.allPlaylistLi.get(a).get("timespan").set("html",b);}.bind(this));}},drawPlaylist:function(){this.addPlaylistElements();this.addPlaylistEvents();},addControllerElements:function(){this.playerSpc=new Element("div",{"class":"flower_soundplayer"});this.soundtitle=new Element("div",{"class":"flower_soundplayer_title",html:"&nbsp;"}).inject(this.playerSpc);this.soundtime=new Element("div",{"class":"flower_soundplayer_time",html:"&nbsp;"}).inject(this.playerSpc);this.seekbarSpc=new Element("div",{"class":"flower_soundplayer_seekbarcontainer",styles:this.elementStyles.get("seekbarSpc")}).inject(this.playerSpc);this.seekbar=new Element("div",{"class":"flower_soundplayer_seekbar",styles:this.elementStyles.get("seekbar")}).inject(this.seekbarSpc);this.position=new Element("div",{"class":"flower_soundplayer_positionmarker",styles:this.elementStyles.get("position")}).inject(this.seekbarSpc);this.controls=new Element("div",{"class":"flower_soundplayer_controls",styles:this.elementStyles.get("controls")}).inject(this.playerSpc);this.previousEl=new Element("img",{"class":"prev",alt:"prev",id:"prev",src:this.options.controlImages.previous,styles:this.elementStyles.get("controlImageStyles"),events:{click:function(){this.playlist.playSound("previous");}.bind(this)}}).inject(this.controls);this.playPauseEl=new Element("img",{"class":"play",alt:"play",id:"play",src:this.options.controlImages.play,styles:this.elementStyles.get("controlImageStyles"),events:{click:function(){this.playlist.toggleCurrentSound();}.bind(this)}}).inject(this.controls);this.nextEl=new Element("img",{"class":"next",alt:"next",id:"next",src:this.options.controlImages.next,styles:this.elementStyles.get("controlImageStyles"),events:{click:function(){this.playlist.playSound("forcenext");}.bind(this)}}).inject(this.controls);this.playerSpc.inject(document.id(this.targetElement));},addControllerEvents:function(){this.seekbar.addEvent("click",function(d){var b;if(!this.playlist.currentSound.sound.loaded){b=this.playlist.currentSound.sound.durationEstimate;}else{b=this.playlist.currentSound.sound.duration;}var g=this.seekbarSpc.getCoordinates();var f=this.seekbar.getCoordinates();var c=(d.page.x-f.left)/g.width;var a=c*b;this.playlist.jumpCurrentSoundTo(a);}.bind(this));this.playlist.SoundPlayer.addEvent("play",function(b,c,a){if(c){this.soundtitle.set("text",c);}else{this.soundtitle.set("text",b);}}.bind(this));this.playlist.SoundPlayer.addEvent("progress",function(b){if(b<0.95){var a=this.seekbarSpc.getSize().x;this.seekbar.setStyle("width",Math.round(a*b));}else{this.seekbar.setStyle("width","100%");}}.bind(this));this.playlist.SoundPlayer.addEvent("position",function(b){var a=this.seekbarSpc.getSize().x;this.position.setStyle("left",Math.round(a*b));}.bind(this));this.playlist.SoundPlayer.addEvent("positiontime",function(a){this.soundtime.set("html",a);}.bind(this));this.playlist.SoundPlayer.addEvent("play",function(){this.playPauseEl.set("src",this.options.controlImages.pause);}.bind(this));this.playlist.SoundPlayer.addEvent("resume",function(){this.playPauseEl.set("src",this.options.controlImages.pause);}.bind(this));this.playlist.SoundPlayer.addEvent("pause",function(){this.playPauseEl.set("src",this.options.controlImages.play);}.bind(this));this.playlist.SoundPlayer.addEvent("stop",function(){this.playPauseEl.set("src",this.options.controlImages.play);}.bind(this));},drawController:function(){this.addControllerElements();this.addControllerEvents();},drawUI:function(){if(this.isAppleiDevice){this.drawPlaylist();}else{this.drawController();this.drawPlaylist();}}});